<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Akıllı Yoklama Sistemi - ENGR 4451</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    .card { 
      background: white; 
      border-radius: 20px; 
      padding: 30px; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }
    h1, h2, h3 { color: #333; }
    input, select, button { 
      width: 100%; 
      padding: 12px; 
      margin: 10px 0; 
      border: 2px solid #ddd; 
      border-radius: 10px;
      font-size: 16px;
    }
    button { 
      background: #667eea; 
      color: white; 
      border: none; 
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    button:hover { background: #5568d3; transform: translateY(-2px); }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .btn-green { background: #2ecc71; }
    .btn-green:hover { background: #27ae60; }
    .btn-red { background: #e74c3c; }
    .btn-red:hover { background: #c0392b; }
    .btn-orange { background: #f39c12; }
    .btn-orange:hover { background: #e67e22; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .message { padding: 15px; border-radius: 10px; margin: 15px 0; font-weight: bold; white-space: pre-line; }
    .message.success { background: #d4edda; color: #155724; }
    .message.error { background: #f8d7da; color: #721c24; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #667eea; color: white; position: sticky; top: 0; }
    .week-cell { width: 25px; height: 25px; border-radius: 5px; display: inline-block; margin: 2px; }
    .status-badge { padding: 5px 15px; border-radius: 20px; font-weight: bold; display: inline-block; font-size: 11px; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 999; }
    .modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 500px; }
    #qrDisplay { background: linear-gradient(135deg, #667eea, #764ba2); padding: 40px; border-radius: 15px; text-align: center; color: white; }
    #qrCodeCanvas { background: white; padding: 20px; border-radius: 15px; display: inline-block; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
    .stat-card { background: #f8f9fa; padding: 20px; border-radius: 15px; text-align: center; }
    .stat-number { font-size: 36px; font-weight: bold; color: #667eea; }
    .stat-label { font-size: 14px; color: #666; margin-top: 5px; }
    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      table { font-size: 10px; }
      th, td { padding: 4px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN VIEW -->
    <div id="loginView" class="card">
      <div style="text-align: center; margin-bottom: 30px;">
        <div style="background: #667eea; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 40px;">📱</div>
        <h1>Akıllı Yoklama Sistemi</h1>
        <p style="color: #666; margin-top: 10px;">ENGR 4451 - Mühendislik Uygulamaları İçin Üretken Yapay Zeka</p>
        <p style="color: #999; font-size: 14px; margin-top: 5px;">📍 Yaşar Üniversitesi</p>
      </div>

      <div id="emailLogin">
        <input type="text" id="loginEmail" placeholder="Email (örn: hoca@universite.edu.tr)">
        <input type="password" id="loginPassword" placeholder="Şifre">
        <button onclick="handleLogin()">👤 Giriş Yap</button>
        <div style="text-align: center; margin: 20px 0; color: #999;">veya</div>
        <button class="btn-green" onclick="showRegisterView()">📝 Yoklama Yap (No/Ad/Soyad)</button>
      </div>

      <div id="registerForm" class="hidden">
        <p style="text-align: center; color: #666; margin-bottom: 20px;">Hafta <strong id="regWeekDisplay">1</strong></p>
        <input type="text" id="registerNo" placeholder="Öğrenci Numaranız (örn: 21070008016)">
        <input type="text" id="registerName" placeholder="Adınız (örn: CAN)" style="text-transform: uppercase;">
        <input type="text" id="registerSurname" placeholder="Soyadınız (örn: GİRGİN)" style="text-transform: uppercase;">
        <input type="text" id="registerCode" placeholder="QR Kod (tahtadan)" style="text-transform: uppercase; font-family: monospace; font-size: 18px;">
        <button class="btn-green" onclick="handleRegister()">📍 Yoklamaya Katıl</button>
        <button class="btn-orange" onclick="showEmailLogin()">⬅️ Geri Dön</button>
        <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-top: 15px; font-size: 13px; color: #1565c0;">
          <strong>📍 Konum Kontrolü:</strong><br>
          Yaşar Üniversitesi kampüsünden 100m içinde olmalısınız.<br>
          <small>Kazımdirik Mah. Üniversite Cad. No:37-39 Bornova/İzmir</small>
        </div>
      </div>

      <div id="loginMessage" class="message hidden"></div>
      <div style="text-align: center; font-size: 12px; color: #999; margin-top: 20px;">
        <p>🔒 Kampüsten 100m içinde olmalısınız</p>
        <p style="margin-top: 5px;">Hoca: hoca@universite.edu.tr</p>
      </div>
    </div>

    <!-- STUDENT VIEW -->
    <div id="studentView" class="hidden">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <div>
            <h2>Yoklama Sistemi</h2>
            <p id="studentName" style="color: #666;"></p>
          </div>
          <button class="btn-red" onclick="logout()" style="width: auto; padding: 10px 20px;">🚪 Çıkış</button>
        </div>

        <div style="background: #e3f2fd; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 20px;">
          <h1 id="currentWeekStudent">1. Hafta</h1>
          <p style="color: #666; margin-top: 10px;">Hoca QR kodu oluşturduğunda katılabilirsiniz</p>
          <p style="font-size: 12px; color: #999; margin-top: 5px;">📍 Kampüsten 100m içinde olmalısınız</p>
        </div>

        <button id="attendBtn" class="btn-green" onclick="handleStudentAttendance()" disabled style="padding: 20px; font-size: 18px;">
          📍 Yoklamaya Katıl
        </button>

        <div id="studentMessage" class="message hidden"></div>

        <div style="margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 15px;">
          <h3>Devamsızlık Durumum</h3>
          <div class="grid" style="margin-top: 15px;">
            <div style="text-align: center;">
              <div style="font-size: 14px; color: #666;">Katılım Oranı</div>
              <div id="studentRate" style="font-size: 36px; font-weight: bold; color: #2ecc71;">%0</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 14px; color: #666;">Durum</div>
              <div id="studentStatus" style="font-size: 28px; font-weight: bold; color: #e74c3c;">YOK</div>
            </div>
          </div>
          <div id="studentWeeks" style="margin-top: 20px;"></div>
        </div>
      </div>
    </div>

    <!-- TEACHER VIEW -->
    <div id="teacherView" class="hidden">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
          <div>
            <h2>Akademisyen Paneli</h2>
            <p style="color: #666;">ENGR 4451 - Mühendislik Uygulamaları İçin Üretken Yapay Zeka</p>
            <p style="font-size: 13px; color: #999;">📍 Yaşar Üniversitesi, Selçuk Yaşar Kampüsü</p>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn-green" onclick="exportToExcel()" style="width: auto; padding: 10px 20px;">📥 Excel İndir</button>
            <button class="btn-red" onclick="logout()" style="width: auto; padding: 10px 20px;">🚪 Çıkış</button>
          </div>
        </div>

        <!-- İstatistikler -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="statAttended">0</div>
            <div class="stat-label">Bu Hafta Katılan</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="statRate">0%</div>
            <div class="stat-label">Ortalama Katılım</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="statTeams">0</div>
            <div class="stat-label">Aktif Takım</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">42</div>
            <div class="stat-label">Toplam Öğrenci</div>
          </div>
        </div>

        <div class="grid">
          <div style="background: #e3f2fd; padding: 20px; border-radius: 15px;">
            <label style="font-weight: bold; color: #666; display: block; margin-bottom: 10px;">Hafta Seçin:</label>
            <select id="weekSelect" onchange="updateWeek()">
              <option value="1">1. Hafta</option>
              <option value="2">2. Hafta</option>
              <option value="3">3. Hafta</option>
              <option value="4">4. Hafta</option>
              <option value="5">5. Hafta</option>
              <option value="6">6. Hafta</option>
              <option value="7">7. Hafta</option>
              <option value="8">8. Hafta</option>
              <option value="9">9. Hafta</option>
              <option value="10">10. Hafta</option>
              <option value="11">11. Hafta</option>
              <option value="12">12. Hafta</option>
              <option value="13">13. Hafta</option>
              <option value="14">14. Hafta</option>
            </select>
          </div>
          <div style="background: #e3f2fd; padding: 20px; border-radius: 15px; display: flex; align-items: center; justify-content: center;">
            <button onclick="generateQR()" style="width: auto; padding: 15px 30px; font-size: 16px;">🎯 QR Kod Oluştur</button>
          </div>
        </div>

        <div id="qrDisplay" class="hidden" style="margin-top: 20px;">
          <div id="qrCodeCanvas" style="background: white; padding: 30px; border-radius: 15px; display: inline-block;"></div>
          <div style="background: white; padding: 20px; border-radius: 15px; margin-top: 20px; display: inline-block;">
            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Manuel Kod:</div>
            <div id="qrTokenText" style="font-family: monospace; font-size: 32px; font-weight: bold; color: #667eea; letter-spacing: 3px;"></div>
          </div>
          <p style="margin-top: 20px; font-size: 18px; font-weight: bold;">Bu QR kodu tahtaya yansıtın</p>
          <p id="qrTimer" style="font-size: 24px; margin-top: 10px;">⏱️ 10:00</p>
        </div>

        <div id="teacherMessage" class="message hidden"></div>
      </div>

      <div class="card" style="overflow-x: auto;">
        <h3 style="margin-bottom: 20px;">📊 Öğrenci Listesi ve Yoklama Durumu</h3>
        <div style="display: flex; gap: 15px; margin-bottom: 15px; font-size: 13px;">
          <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 20px; height: 20px; background: #2ecc71; border-radius: 3px;"></div>
            <span>Var</span>
          </div>
          <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 20px; height: 20px; background: #e74c3c; border-radius: 3px;"></div>
            <span>Yok</span>
          </div>
          <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 20px; height: 20px; background: #ecf0f1; border-radius: 3px;"></div>
            <span>Henüz Gelmedi</span>
          </div>
          <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 20px; height: 20px; background: #ffe5cc; border-radius: 3px;"></div>
            <span>Risk Altında</span>
          </div>
        </div>
        <table id="studentTable">
          <thead>
            <tr>
              <th>Öğrenci No</th>
              <th>Ad Soyad</th>
              <th>Bölüm</th>
              <th>T</th>
              <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th>
              <th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th>
              <th>Toplam</th>
              <th>Oran</th>
              <th>Durum</th>
              <th>İşlem</th>
            </tr>
          </thead>
          <tbody id="studentTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- MODAL - İptal Onayı -->
    <div id="invalidateModal" class="modal" style="display: none;">
      <div class="modal-content">
        <h3 style="color: #e74c3c; margin-bottom: 15px;">⚠️ Yoklamayı İptal Et</h3>
        <p id="invalidateText" style="color: #666; margin-bottom: 20px;"></p>
        <div style="display: flex; gap: 10px;">
          <button class="btn-red" onclick="confirmInvalidate()">Evet, İptal Et</button>
          <button onclick="closeModal()">Vazgeç</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // GLOBAL VARIABLES
    let currentView = 'login';
    let currentUser = null;
    let currentWeek = 1;
    let qrToken = '';
    let qrExpiry = null;
    let timerInterval = null;
    let selectedStudent = null;
    let deviceId = localStorage.getItem('deviceId') || generateDeviceId();

    const COURSE_CODE = 'ENGR 4451';
    const COURSE_NAME = 'Mühendislik Uygulamaları İçin Üretken Yapay Zeka';
    const CAMPUS_LOCATION = { lat: 38.454113, lng: 27.202612, radius: 100 };
    
    let students = [
      { id: 1, no: '18070003013', ad: 'İBRAHİM', soyad: 'GÜLTEKİN', bolum: 'İNŞAAT MÜH.', team: 1, email: '18070003013@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 2, no: '19070001053', ad: 'ELİF EMİNE', soyad: 'GÜNAL', bolum: 'BİLGİSAYAR MÜH.', team: 2, email: '19070001053@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 3, no: '19070008012', ad: 'ERK YANKI', soyad: 'URAL', bolum: 'MAKİNE MÜH.', team: 2, email: '19070008012@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 4, no: '20070001057', ad: 'ERCE', soyad: 'ÖZKAN', bolum: 'BİLGİSAYAR MÜH.', team: 5, email: '20070001057@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 5, no: '20070002048', ad: 'İPEK', soyad: 'ATIŞ', bolum: 'ENDÜSTRİ MÜH.', team: 7, email: '20070002048@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 6, no: '20070007004', ad: 'İDİL ECE', soyad: 'CEVAHİR', bolum: 'ENERJİ SİSTEMLERİ MÜH.', team: 7, email: '20070007004@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 7, no: '20070008016', ad: 'SUDE', soyad: 'ONFİDAN', bolum: 'MAKİNE MÜH.', team: 6, email: '20070008016@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 8, no: '20070008017', ad: 'ÖMER', soyad: 'ARICA', bolum: 'MAKİNE MÜH.', team: 2, email: '20070008017@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 9, no: '20070008019', ad: 'SELİM MERT', soyad: 'KIRCAALİLİ', bolum: 'MAKİNE MÜH.', team: 6, email: '20070008019@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 10, no: '20070008029', ad: 'BERİL DERAN', soyad: 'GÜRBÜZ', bolum: 'MAKİNE MÜH.', team: 4, email: '20070008029@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 11, no: '21070001004', ad: 'ALİ HAKTAN', soyad: 'SIĞIN', bolum: 'BİLGİSAYAR MÜH.', team: 12, email: '21070001004@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 12, no: '21070001051', ad: 'ARDA', soyad: 'ALTUNHAN', bolum: 'BİLGİSAYAR MÜH.', team: 5, email: '21070001051@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 13, no: '21070001070', ad: 'EKREM', soyad: 'TEMEL', bolum: 'BİLGİSAYAR MÜH.', team: 5, email: '21070001070@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 14, no: '21070002005', ad: 'NESRİN', soyad: 'ŞENTÜRK', bolum: 'ENDÜSTRİ MÜH.', team: 11, email: '21070002005@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 15, no: '21070002025', ad: 'BATUHAN', soyad: 'ŞİŞMAN', bolum: 'ENDÜSTRİ MÜH.', team: 11, email: '21070002025@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 16, no: '21070005027', ad: 'KIVANÇ EFE', soyad: 'ERGÖNÜL', bolum: 'ELEKTRİK-ELEKTRONİK MÜH.', team: 2, email: '21070005027@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 17, no: '21070005030', ad: 'OĞUZ', soyad: 'KOYUCAN', bolum: 'ELEKTRİK-ELEKTRONİK MÜH.', team: 8, email: '21070005030@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 18, no: '21070005042', ad: 'ZEYNEP', soyad: 'ARSLANBUĞA', bolum: 'ELEKTRİK-ELEKTRONİK MÜH.', team: 2, email: '21070005042@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 19, no: '21070007001', ad: 'BESTE', soyad: 'TEKİN', bolum: 'ENERJİ SİSTEMLERİ MÜH.', team: 7, email: '21070007001@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 20, no: '21070007004', ad: 'EKİN', soyad: 'ALTUNKAYA', bolum: 'ENERJİ SİSTEMLERİ MÜH.', team: 10, email: '21070007004@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 21, no: '21070008009', ad: 'EMRE', soyad: 'ERİŞİR', bolum: 'MAKİNE MÜH.', team: 8, email: '21070008009@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 22, no: '21070008014', ad: 'İSMAİL CANBERK', soyad: 'DEMİRKAN', bolum: 'MAKİNE MÜH.', team: 3, email: '21070008014@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 23, no: '21070008016', ad: 'CAN', soyad: 'GİRGİN', bolum: 'MAKİNE MÜH.', team: 9, email: '21070008016@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 24, no: '21070008017', ad: 'KEREM', soyad: 'EROĞLU', bolum: 'MAKİNE MÜH.', team: 1, email: '21070008017@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 25, no: '21070008027', ad: 'ARMAĞAN', soyad: 'SOYLU', bolum: 'MAKİNE MÜH.', team: 4, email: '21070008027@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 26, no: '21070008033', ad: 'ALP SERKAN', soyad: 'MERKİT', bolum: 'MAKİNE MÜH.', team: 8, email: '21070008033@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 27, no: '21070008034', ad: 'ATAKAN', soyad: 'DİNÇER', bolum: 'MAKİNE MÜH.', team: 3, email: '21070008034@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 28, no: '21070008206', ad: 'DEMET', soyad: 'BÜYÜKTAŞ', bolum: 'MAKİNE MÜH.', team: 4, email: '21070008206@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 29, no: '22070001041', ad: 'GÜRKAN', soyad: 'EROĞLU', bolum: 'BİLGİSAYAR MÜH.', team: 1, email: '22070001041@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 30, no: '22070001055', ad: 'EMRE EFE', soyad: 'YÜKSEL', bolum: 'BİLGİSAYAR MÜH.', team: 12, email: '22070001055@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 31, no: '22070002015', ad: 'SÜLEYMAN BATU', soyad: 'SARI', bolum: 'ENDÜSTRİ MÜH.', team: 10, email: '22070002015@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 32, no: '22070002047', ad: 'KADİR EMRE', soyad: 'GÜNEŞ', bolum: 'ENDÜSTRİ MÜH.', team: 10, email: '22070002047@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 33, no: '22070005040', ad: 'TOPRAK', soyad: 'TUNCER', bolum: 'ELEKTRİK-ELEKTRONİK MÜH.', team: 6, email: '22070005040@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 34, no: '22070005053', ad: 'EMRE CAN', soyad: 'HEKİMOĞLU', bolum: 'ELEKTRİK-ELEKTRONİK MÜH.', team: 6, email: '22070005053@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 35, no: '22070007014', ad: 'ILGAR', soyad: 'ŞENOL', bolum: 'ENERJİ SİSTEMLERİ MÜH.', team: 10, email: '22070007014@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 36, no: '22070008017', ad: 'EDA NUR', soyad: 'ÇALIŞKAN', bolum: 'MAKİNE MÜH.', team: 9, email: '22070008017@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 37, no: '22070008021', ad: 'SAMİ BERK', soyad: 'ŞAHİN', bolum: 'MAKİNE MÜH.', team: 3, email: '22070008021@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 38, no: '22070008026', ad: 'DENİZ', soyad: 'ÜNVER', bolum: 'MAKİNE MÜH.', team: 9, email: '22070008026@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 39, no: '22070008034', ad: 'AYKAN', soyad: 'KANLI', bolum: 'MAKİNE MÜH.', team: 4, email: '22070008034@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 40, no: '22070008043', ad: 'DENİZ', soyad: 'KARATEPE', bolum: 'MAKİNE MÜH.', team: 9, email: '22070008043@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 41, no: '22070003022', ad: 'AYŞEGÜL', soyad: 'KARINYARICI', bolum: 'İNŞAAT MÜH.', team: 1, email: '22070003022@ogrenci.edu.tr', yoklamalar: [], deviceId: null },
      { id: 42, no: '21070001046', ad: 'AHMET ÖZGÜR', soyad: 'KORKMAZ', bolum: 'BİLGİSAYAR MÜH.', team: 12, email: '21070001046@ogrenci.edu.tr', yoklamalar: [], deviceId: null }
    ];

    // CİHAZ ID OLUŞTUR
    function generateDeviceId() {
      const id = 'device_' + Math.random().toString(36).substr(2, 9) + Date.now();
      localStorage.setItem('deviceId', id);
      return id;
    }

    // KONUM KONTROLÜ
    function checkLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject('Tarayıcınız konum özelliğini desteklemiyor.');
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            
            const R = 6371e3;
            const φ1 = CAMPUS_LOCATION.lat * Math.PI / 180;
            const φ2 = userLat * Math.PI / 180;
            const Δφ = (userLat - CAMPUS_LOCATION.lat) * Math.PI / 180;
            const Δλ = (userLng - CAMPUS_LOCATION.lng) * Math.PI / 180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;

            if (distance <= CAMPUS_LOCATION.radius) {
              resolve({ distance: distance.toFixed(0) });
            } else {
              reject('Yaşar Üniversitesi kampüsüne çok uzaksınız!\n\nMesafe: ' + distance.toFixed(0) + ' metre\nİzin: ' + CAMPUS_LOCATION.radius + ' metre\n\nYoklamaya sadece kampüsten katılabilirsiniz.');
            }
          },
          (error) => {
            reject('Konum izni vermeniz gerekiyor!');
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      });
    }

    // MESAJ GÖSTER
    function showMessage(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = 'message ' + type;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 6000);
    }

    // VIEW DEĞİŞTİR
    function showView(viewName) {
      document.getElementById('loginView').classList.add('hidden');
      document.getElementById('studentView').classList.add('hidden');
      document.getElementById('teacherView').classList.add('hidden');
      document.getElementById(viewName + 'View').classList.remove('hidden');
      currentView = viewName;
    }

    function showRegisterView() {
      document.getElementById('emailLogin').classList.add('hidden');
      document.getElementById('registerForm').classList.remove('hidden');
      document.getElementById('regWeekDisplay').textContent = currentWeek;
    }

    function showEmailLogin() {
      document.getElementById('emailLogin').classList.remove('hidden');
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('registerNo').value = '';
      document.getElementById('registerName').value = '';
      document.getElementById('registerSurname').value = '';
      document.getElementById('registerCode').value = '';
    }

    // LOGIN
    function handleLogin() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      if (email === 'hoca@universite.edu.tr') {
        currentUser = { role: 'teacher', name: 'Öğretim Üyesi' };
        showView('teacher');
        loadTeacherView();
      } else if (email.includes('@ogrenci.edu.tr')) {
        const student = students.find(s => s.email === email);
        if (student) {
          currentUser = { role: 'student', ...student };
          showView('student');
          loadStudentView();
        } else {
          showMessage('loginMessage', '❌ Bu email sistemde kayıtlı değil!', 'error');
        }
      } else {
        showMessage('loginMessage', '❌ Lütfen okul email adresi kullanın!', 'error');
      }
    }

    // YOKLAMA KAYIT
    async function handleRegister() {
      const no = document.getElementById('registerNo').value.trim();
      const ad = document.getElementById('registerName').value.trim().toUpperCase();
      const soyad = document.getElementById('registerSurname').value.trim().toUpperCase();
      const code = document.getElementById('registerCode').value.trim().toUpperCase();

      if (!no || !ad || !soyad) {
        showMessage('loginMessage', '❌ Lütfen tüm bilgileri giriniz!', 'error');
        return;
      }

      if (!qrToken || new Date() > qrExpiry) {
        showMessage('loginMessage', '❌ Geçerli QR kod yok! Hoca henüz QR kod oluşturmadı.', 'error');
        return;
      }

      if (code !== qrToken) {
        showMessage('loginMessage', '❌ Girdiğiniz kod yanlış!', 'error');
        return;
      }

      // CİHAZ KONTROLÜ
      const student = students.find(s => s.no === no && s.ad === ad && s.soyad === soyad);
      if (!student) {
        showMessage('loginMessage', '❌ Bilgileriniz sistemde bulunamadı! Öğrenci no, ad ve soyadınızı kontrol edin.', 'error');
        return;
      }

      if (student.deviceId && student.deviceId !== deviceId) {
        showMessage('loginMessage', '❌ Bu öğrenci başka bir cihazdan giriş yaptı! Bir cihazdan sadece 1 kişi giriş yapabilir.', 'error');
        return;
      }

      // KONUM KONTROLÜ
      showMessage('loginMessage', '📍 Konumunuz kontrol ediliyor...', 'success');
      try {
        const location = await checkLocation();
        
        if (student.yoklamalar.includes(currentWeek)) {
          showMessage('loginMessage', '⚠️ Bu hafta zaten yoklamaya katıldınız!', 'error');
          return;
        }

        student.yoklamalar.push(currentWeek);
        student.yoklamalar.sort((a,b) => a-b);
        student.deviceId = deviceId;

        showMessage('loginMessage', '✅ Yoklamanız kaydedildi, ' + student.ad + ' ' + student.soyad + '!\n📍 Kampüsten ' + location.distance + 'm içinde', 'success');
        
        document.getElementById('registerNo').value = '';
        document.getElementById('registerName').value = '';
        document.getElementById('registerSurname').value = '';
        document.getElementById('registerCode').value = '';
      } catch (error) {
        showMessage('loginMessage', '❌ ' + error, 'error');
      }
    }

    // ÖĞRENCİ YOKLAMA
    async function handleStudentAttendance() {
      if (!qrToken || new Date() > qrExpiry) {
        showMessage('studentMessage', '❌ Geçerli QR kod yok!', 'error');
        return;
      }

      showMessage('studentMessage', '📍 Konumunuz kontrol ediliyor...', 'success');
      try {
        const location = await checkLocation();

        if (currentUser.yoklamalar.includes(currentWeek)) {
          showMessage('studentMessage', '⚠️ Bu hafta zaten yoklamaya katıldınız!', 'error');
          return;
        }

        const student = students.find(s => s.id === currentUser.id);
        student.yoklamalar.push(currentWeek);
        student.yoklamalar.sort((a,b) => a-b);
        currentUser.yoklamalar = student.yoklamalar;

        showMessage('studentMessage', '✅ Yoklamanız kaydedildi!\n📍 Mesafe: ' + location.distance + 'm', 'success');
        loadStudentView();
      } catch (error) {
        showMessage('studentMessage', '❌ ' + error, 'error');
      }
    }

    // QR KOD OLUŞTUR
    function generateQR() {
      qrToken = 'QR' + Math.random().toString(36).substr(2, 6).toUpperCase();
      qrExpiry = new Date(Date.now() + 10 * 60 * 1000);

      document.getElementById('qrDisplay').classList.remove('hidden');
      document.getElementById('qrCodeCanvas').innerHTML = '';
      document.getElementById('qrTokenText').textContent = qrToken;
      
      new QRCode(document.getElementById('qrCodeCanvas'), {
        text: qrToken,
        width: 256,
        height: 256
      });

      startTimer();
      showMessage('teacherMessage', '✅ QR Kod oluşturuldu! Öğrenciler kodu kullanabilir.', 'success');
      
      // Öğrenci butonlarını aktif et
      document.getElementById('attendBtn').disabled = false;
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      
      timerInterval = setInterval(() => {
        const remaining = Math.max(0, Math.floor((qrExpiry - Date.now()) / 1000));
        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        document.getElementById('qrTimer').textContent = '⏱️ ' + mins + ':' + secs.toString().padStart(2, '0');
        
        if (remaining === 0) {
          clearInterval(timerInterval);
          document.getElementById('qrDisplay').classList.add('hidden');
          qrToken = '';
          document.getElementById('attendBtn').disabled = true;
        }
      }, 1000);
    }

    function updateWeek() {
      currentWeek = parseInt(document.getElementById('weekSelect').value);
      document.getElementById('regWeekDisplay').textContent = currentWeek;
      if (currentView === 'teacher') loadTeacherView();
      if (currentView === 'student') {
        document.getElementById('currentWeekStudent').textContent = currentWeek + '. Hafta';
      }
    }

    // HESAPLAMALAR
    function calculateAttendance(student) {
      const rate = (student.yoklamalar.length / 14) * 100;
      const remaining = 14 - currentWeek;
      const maxPossible = student.yoklamalar.length + remaining;
      const maxRate = (maxPossible / 14) * 100;
      
      let status = 'VAR', color = '#d4edda', textColor = '#155724';
      if (rate < 70) {
        status = 'YOK';
        color = '#f8d7da';
        textColor = '#721c24';
      } else if (maxRate < 75) {
        color = '#fff3cd';
        textColor = '#856404';
      }
      
      return { rate: rate.toFixed(1), status, color, textColor };
    }

    function calculateTeamStats() {
      const teams = {};
      students.forEach(s => {
        if (!teams[s.team]) teams[s.team] = { total: 0, attended: 0 };
        teams[s.team].total++;
        if (s.yoklamalar.includes(currentWeek)) teams[s.team].attended++;
      });

      let activeTeams = 0;
      Object.values(teams).forEach(t => {
        if (t.attended > t.total / 2) activeTeams++;
      });

      return activeTeams;
    }

    // ÖĞRENCİ VIEW
    function loadStudentView() {
      document.getElementById('studentName').textContent = currentUser.ad + ' ' + currentUser.soyad + ' (' + currentUser.no + ')';
      document.getElementById('currentWeekStudent').textContent = currentWeek + '. Hafta';

      const attendance = calculateAttendance(currentUser);
      document.getElementById('studentRate').textContent = '%' + attendance.rate;
      document.getElementById('studentStatus').textContent = attendance.status;
      document.getElementById('studentRate').style.color = attendance.rate >= 70 ? '#2ecc71' : '#e74c3c';
      document.getElementById('studentStatus').style.color = attendance.rate >= 70 ? '#2ecc71' : '#e74c3c';

      let weeksHtml = '<div style="display: flex; gap: 3px; flex-wrap: wrap;">';
      for (let i = 1; i <= 14; i++) {
        let color = '#ecf0f1';
        if (currentUser.yoklamalar.includes(i)) color = '#2ecc71';
        else if (i <= currentWeek) color = '#e74c3c';
        weeksHtml += '<div class="week-cell" style="background: ' + color + ';" title="Hafta ' + i + '"></div>';
      }
      weeksHtml += '</div>';
      document.getElementById('studentWeeks').innerHTML = weeksHtml;

      document.getElementById('attendBtn').disabled = !qrToken || new Date() > qrExpiry;
    }

    // HOCA VIEW
    function loadTeacherView() {
      const attendedThisWeek = students.filter(s => s.yoklamalar.includes(currentWeek));
      const totalRate = students.reduce((sum, s) => sum + (s.yoklamalar.length / 14) * 100, 0) / students.length;
      const activeTeams = calculateTeamStats();

      document.getElementById('statAttended').textContent = attendedThisWeek.length;
      document.getElementById('statRate').textContent = totalRate.toFixed(1) + '%';
      document.getElementById('statTeams').textContent = activeTeams;

      let html = '';
      students.forEach(student => {
        const att = calculateAttendance(student);
        const attendedThisWeekBool = student.yoklamalar.includes(currentWeek);
        
        html += '<tr style="background: ' + att.color + ';">';
        html += '<td>' + student.no + '</td>';
        html += '<td><strong>' + student.ad + ' ' + student.soyad + '</strong></td>';
        html += '<td style="font-size: 10px;">' + student.bolum + '</td>';
        html += '<td style="text-align: center;"><strong>' + student.team + '</strong></td>';
        
        for (let i = 1; i <= 14; i++) {
          let color = '#ecf0f1';
          if (student.yoklamalar.includes(i)) color = '#2ecc71';
          else if (i <= currentWeek) color = '#e74c3c';
          html += '<td style="text-align: center;"><div class="week-cell" style="background: ' + color + '; margin: 0 auto;"></div></td>';
        }
        
        html += '<td style="text-align: center;"><strong>' + student.yoklamalar.length + '</strong></td>';
        html += '<td style="text-align: center;"><strong>' + att.rate + '%</strong></td>';
        html += '<td style="text-align: center;"><span class="status-badge" style="background: ' + att.color + '; color: ' + att.textColor + ';">' + att.status + '</span></td>';
        html += '<td style="text-align: center;">';
        if (attendedThisWeekBool) {
          html += '<button class="btn-red" style="width: auto; padding: 5px 10px; font-size: 11px;" onclick="invalidateAttendance(' + student.id + ')">❌ İptal</button>';
        } else {
          html += '<span style="color: #ccc;">-</span>';
        }
        html += '</td>';
        html += '</tr>';
      });
      
      document.getElementById('studentTableBody').innerHTML = html;
    }

    // YOKLAMA İPTAL
    function invalidateAttendance(studentId) {
      selectedStudent = students.find(s => s.id === studentId);
      document.getElementById('invalidateText').textContent = selectedStudent.ad + ' ' + selectedStudent.soyad + ' öğrencisinin ' + currentWeek + '. hafta yoklamasını geçersiz saymak istediğinizden emin misiniz?';
      document.getElementById('invalidateModal').style.display = 'flex';
    }

    function confirmInvalidate() {
      selectedStudent.yoklamalar = selectedStudent.yoklamalar.filter(h => h !== currentWeek);
      showMessage('teacherMessage', '✅ ' + selectedStudent.ad + ' ' + selectedStudent.soyad + ' öğrencisinin ' + currentWeek + '. hafta yoklaması iptal edildi!', 'success');
      closeModal();
      loadTeacherView();
    }

    function closeModal() {
      document.getElementById('invalidateModal').style.display = 'none';
      selectedStudent = null;
    }

    // EXCEL EXPORT
    function exportToExcel() {
      let csv = '\ufeff';
      csv += 'Öğrenci No\tAd\tSoyad\tBölüm\tTakım\t';
      
      for (let i = 1; i <= 14; i++) {
        csv += 'Hafta ' + i + '\t';
      }
      csv += 'Toplam Katılım\tKatılım Oranı\tDurum\n';
      
      students.forEach(student => {
        const att = calculateAttendance(student);
        csv += student.no + '\t';
        csv += student.ad + '\t';
        csv += student.soyad + '\t';
        csv += student.bolum + '\t';
        csv += student.team + '\t';
        
        for (let i = 1; i <= 14; i++) {
          csv += (student.yoklamalar.includes(i) ? 'VAR' : 'YOK') + '\t';
        }
        
        csv += student.yoklamalar.length + '\t';
        csv += '%' + att.rate + '\t';
        csv += att.status + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'yoklama_' + COURSE_CODE.replace(' ', '_') + '_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      showMessage('teacherMessage', '✅ Excel dosyası indirildi!', 'success');
    }

    // ÇIKIŞ
    function logout() {
      currentUser = null;
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
      showEmailLogin();
      showView('login');
    }
  </script>
</body>
</html>